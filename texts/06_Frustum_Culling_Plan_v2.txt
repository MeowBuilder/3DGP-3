# 절두체 컬링 및 계층형 바운딩 박스 개선 계획 (Frustum Culling Plan v2)

## 1. 개선 목표 (Goals)
1. **계층적 AABB 갱신 (Hierarchical AABB Update)**: 루트 오브젝트의 AABB가 모든 하위 자식(Child/Sibling)들의 AABB를 포함하도록 구현합니다. 이를 통해 루트가 컬링되면 하위 전체를 렌더링에서 제외합니다.
2. **절두체 통합**: `CCamera`에 `BoundingFrustum`을 적용하여 정확한 컬링 검사를 수행합니다.

## 2. 상세 구현 계획 (Implementation Details)

### A. CCamera 수정 (절두체 관리)
- `DirectX::BoundingFrustum` 멤버 추가.
- `UpdateShaderVariables()` 또는 행렬이 갱신되는 시점에 `BoundingFrustum`도 함께 갱신합니다.
  - 투영 행렬로부터 View Space Frustum 생성.
  - 뷰 행렬의 역행렬(Inverse View)을 사용하여 World Space Frustum으로 변환.

### B. CGameObject 수정 (계층적 AABB)

#### 1. 멤버 변수 정리
- `m_LocalAABB`: 메쉬의 AABB (자신만의 순수 영역).
- `m_WorldAABB`: 자신의 `m_LocalAABB`를 월드 변환한 AABB.
- `m_HierarchicalAABB` (신규): 자신 + 모든 자식들을 포함하는 통합 AABB. 컬링 검사는 이것으로 수행합니다.

#### 2. 초기화 (`SetMesh`)
- 메쉬가 설정될 때 `m_LocalAABB`를 초기화합니다.

#### 3. 갱신 로직 (`UpdateBoundingBox`)
이 메서드는 `UpdateTransform` 이후, 렌더링 전에 호출되어야 합니다. 재귀적 호출(후위 순회)이 필요합니다.

```cpp
void CGameObject::UpdateBoundingBox() {
    // 1. 자신의 m_WorldAABB 계산
    // m_LocalAABB를 현재 월드 행렬(m_xmf4x4World)로 변환 -> m_WorldAABB
    m_LocalAABB.Transform(m_WorldAABB, XMLoadFloat4x4(&m_xmf4x4World));
    
    // 초기 계층 AABB는 자신의 월드 AABB로 시작
    m_HierarchicalAABB = m_WorldAABB; 

    // 2. 자식들의 AABB 병합 (Sibling은 병합하지 않음! Sibling은 부모 입장에서 별개의 자식임)
    if (m_pChild) {
        m_pChild->UpdateBoundingBox(); // 자식 먼저 갱신 (재귀)
        
        // 자식(및 자식의 형제들)을 순회하며 병합
        CGameObject* pChild = m_pChild;
        while(pChild) {
             DirectX::BoundingBox::CreateMerged(m_HierarchicalAABB, m_HierarchicalAABB, pChild->m_HierarchicalAABB);
             pChild = pChild->m_pSibling;
        }
    }
    
    // 주의: m_pSibling에 대한 호출은 여기서 하지 않음. 부모가 자식 리스트를 순회할 때 처리하거나, 
    // 외부 루프에서 형제들을 호출해야 함. 구조상 UpdateBoundingBox는 "나와 내 자식들"만 책임지는 게 깔끔함.
}
```

### C. Scene/GameFramework 수정
1. **AABB 갱신 호출**:
   - `AnimateObjects` 이후, `Render` 이전에 씬의 최상위 오브젝트들에 대해 `UpdateBoundingBox()`를 호출합니다. (형제 노드 순회 필요)
   
2. **컬링 및 렌더링 (`Render`)**:
   - 카메라의 `IsInFrustum(pGameObject->m_HierarchicalAABB)`를 검사.
   - 실패 시: `return` (자신과 자식들 모두 렌더링 스킵).
   - 성공 시:
     - 자신의 메쉬가 있다면 렌더링.
     - 자식(`m_pChild`)에 대해 `Render` 재귀 호출.
     - 형제(`m_pSibling`)에 대해 `Render` 재귀 호출 (형제는 별도 검사 필요).

## 3. 작업 순서
1. `CCamera`에 절두체 기능 추가.
2. `CGameObject`에 `m_LocalAABB`, `m_HierarchicalAABB` 추가 및 `SetMesh`에서 초기화 로직 구현.
3. `CGameObject::UpdateBoundingBox` 구현 (재귀적 병합).
4. `CScene::Render` 및 `CGameObject::Render`에 컬링 로직 적용.
